<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <!-- The CSS package above applies Google styling to buttons and other elements. -->

  <style>
    .branding-below {
      bottom: 56px;
      top: 0;
    }

    .branding-text {
      left: 7px;
      position: relative;
      top: 3px;
    }

    .col-contain {
      overflow: hidden;
    }

    .col-one {
      float: left;
      width: 50%;
    }

    .logo {
      vertical-align: middle;
    }

    .radio-spacer {
      height: 20px;
    }

    .width-100 {
      width: 100%;
    }
  </style>
</head>

<body>
  <div class="sidebar branding-below">
    <h2>Writing Style</h2>
    <div id="scanningMsgDiv">
      <div id="scanningMsg">Scanning document...</div>
    </div>

    <div id="resultsDiv" style="display: none">
        <div id="systemErrorDiv" style="display: none">
            <p id="systemErrorMsg">An error occurred scanning your document.</p>
        </div>
      <div id="errorsFoundDiv" style="display: none">
        <h3 id="errorsFoundMsg"></h3>
        <hr>
        <h4>Passive Voice</h4>
        <div style="margin-left: 1rem">
            <p>These sentences use passive voice.  Try to maintain an active voice, such as: 
                <br/>
                Charles <strong><em>ran</em></strong> on the field.
            </p>
        </div>
        <div id="errorsListDiv"></div>
      </div>
      <div id="noErrorsDiv" style="display: none">
        <p>No errors found.</p>
      </div>
    </div>

    <br/>
    <div id="rescanBtnDiv" style="display: none">
      <button id="rescanBtn">Re-scan Document</button>
    </div>
  </div>

  <div class="sidebar bottom">
  </div>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>
    /**
     * On document load, assign click handlers to each button and try to load the
     * user's origin and destination language preferences if previously set.
     */
    $(function () {
      $('#rescanBtn').click(scanDocument);
      scanDocument();
    });

    /**
     * Request the server to scan the opened document.
     */ 
    function scanDocument() {
      $('#scanningMsgDiv').show();
      $("#resultsDiv").hide();
      $('#rescanBtnDiv').hide();
      $('#systemErrorDiv').hide();
      $('#errorsFoundDiv').hide();
      $('#noErrorsDiv').hide();
      $('#errorsListDiv').empty();

      google.script.run
        .withSuccessHandler(renderResults)
        .withFailureHandler(
          function () {
            $('#scanningMsgDiv').hide();
            $('#systemErrorDiv').show();
            $('#rescanBtnDov').show();
          })
        .scanDocument();
    }

  /**
   * Renders the suggestions returned from the server for the user.
   */
  function renderResults(results) {
    if (results.length === 0) {
      $('#noErrorsDiv').show();
    } else {
      var errorsText = results.length === 1 ? 'One suggestion found' : results.length + ' suggestions found.';
      $('#errorsFoundMsg').text(errorsText);
      $('#errorsFoundDiv').show();
      
      for (let result of results) {
        // let beforeError = result.elementText.substring(0, result.startOffset);
        let errorText = result.elementText.substring(
          result.startOffset,
          result.endOffset + 1);
        // let afterError = result.elementText.substring(result.endOffset + 1);

        let $errorTextNode = $("<strong></strong>").text(errorText);
        let $resultNode = $("<div></div>");
        $resultNode.append($("<p></p>").html($errorTextNode.prop('outerHTML')));

        // let $correctButton = $("<button></button").text('Correct');
        // $correctButton.data({
        //   paragraphNum: result.paragraphNum,
        //   startOffset: result.startOffset, 
        //   endOffset: result.endOffset,
        //   replaceText: 'cried'
        // });
        // $correctButton.click(correctError);
        // $resultNode.append($correctButton);
        // $correctButton.css('display', 'inline');

        $('#errorsListDiv').append($resultNode);
      }
    }
    $('#scanningMsgDiv').hide();
    $('#resultsDiv').show();
    $('#rescanBtnDiv').show();
  }

  /**
   * Requests the selected suggestion to be made to the document.
   * @param suggestionButton the 'Correct' button for a given suggestion
   */
  function correctError (suggestionButton) {
      var buttonPressed = $(suggestionButton.target);

      buttonPressed.prop('disabled', true);
      buttonPressed.text('Correcting...');

      google.script.run
      .withSuccessHandler(
        function () {
          buttonPressed.text('Corrected');
        })
      .correctError(buttonPressed.data());
  }
  </script>
</body>

</html>