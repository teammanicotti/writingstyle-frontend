<!DOCTYPE html>
<html>

<head>
  <base target="_top">
    <!--<meta http-equiv="Content-Security-Policy" content="default-src none; script-src manicotti.se.rit.edu ajax.googleapis.com">-->
    <!--<meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' ssl.gstatic.com 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval' ajax.googleapis.com  manicotti.se.rit.edu">-->
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <!-- The CSS package above applies Google styling to buttons and other elements. -->

  <style>
    .branding-below {
      bottom: 0px;
      top: 0;
      height: 100%;
      overflow: hidden;
    }

    .branding-text {
      left: 7px;
      position: relative;
      top: 3px;
    }

    .col-contain {
      overflow: hidden;
    }

    .col-one {
      float: left;
      width: 50%;
    }

    .logo {
      vertical-align: middle;
      vertical-align: middle;
    }

    .radio-spacer {
      height: 20px;
    }

    .width-100 {
      width: 100%;
    }

    .recommendationCard {
        opacity: 0.8;
        background: #1464f6;
        border-radius: 15px;
        padding: 15px;
        text-align:left;
        overflow: hidden;
        margin-top: 5px;
    }

    .recommendationCard:hover {
        opacity: 1;
        box-shadow: 0 0 8px grey;
        transition-duration: 150ms;
        transition-property: box-shadow;
    }

    .pargraphLabel{
      /*margin-top: 5px;*/
      font: 15px arial;
      display:flex;
      flex-direction: row;
      justify-content: left;
      align-items: center;
    }
    #pargraphOneSettings{
      display:flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      height: 3%;
      min-height: 20px;
    }

    #paragraphOne{
      font: 15px arial;
      /*display: inline-block;*/
      float: left;
      display:flex;
      flex-direction: row;
      justify-content: left;
      align-items: center;
      visibility: hidden;
    }

    #settingsIcon {
      height: 20px;
      width: 20px;
      display: inline-block;
      float: right;
      justify-self: right;
    }

    .collapse {
      height: 20px;
      width: 20px;
      display: inline-block;
      float: right;
      justify-self: left;
    }


    .recHeader{
        text-align: center;
    }

    .recHeaderText{
        text-align:left;
        color: white;
        float:left;
        font: 20px arial;
        width: 80%;

    }

    .recIconThumb{
        float:right;
        width:20px;
        height:20px;
        margin-right: 2px;
    }

    .recIconThumb:hover{
      width:22px;
      height:22px;
    }

    .recText{
        color: white;
        float: left;
        font: 12px arial;
        padding-top: 5px;
    }

    .recSubTitle{
        font-style: italic;
    }


    #analyzeBtn {
      background: #616161;
      border-radius: 15px;
      padding: 10px;
      text-align:center;
      overflow: hidden;
      margin-top: 5px;
      font: 20px arial;
      color: white;
      cursor: default;
      height: 3%;
    }

    #options {
      background: white;
      text-align:right;
      overflow: hidden;
      cursor: default;
    }

    #errors {
      background: red;
      text-align:right;
      overflow: hidden;
      cursor: default;
      display: none;
      height: 20px;
    }

    .paragraph_recs{
      display: inline-block;
    }

    #clearHidden {
      background: #1464f6;
      border-radius: 5px;
      text-align:center;
      overflow: hidden;
      padding: 5px;
      font: 15px arial;
      color: white;
      cursor: default;
      width: 90%;
      display: none;
      margin: auto;
    }

    #refreshPng{
      height: 15px;
      width: 15px;
      filter: invert(100);
      -webkit-animation: spin 4s infinite linear;
    }

    @-webkit-keyframes spin {
      0%  {-webkit-transform: rotate(0deg);}
      100% {-webkit-transform: rotate(360deg);}
    }

    #recommendations{
      height: 90%;
      display: block;
      overflow: auto;
    }


  </style>
</head>

<body>
  <div class="sidebar branding-below">
    <div id="options">
      <div id="clearHidden">
        Clear Hidden Items
      </div>
    </div>
    <div id="errors">

    </div>
    <div id="pargraphOneSettings">
      <div id="paragraphOne">
        Paragraph: 1
        <img id='paragraph_1' class='collapse' src='http://manicotti.se.rit.edu/plus.png' alt='plus'>
      </div>
      <img id='settingsIcon' src="http://manicotti.se.rit.edu/settings.png" alt="settings">
    </div>
    <div id="recommendations">
        <!--Recommendation cards load here -->
      </div>
    <div id="analyzeBtn">
      Analyze
      <img id="refreshPng" src="https://img.icons8.com/windows/32/000000/refresh.png">
    </div>
  </div>
</body>
<script src="//ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script>
    var undo_items = [];
    var redo_items = [];

    /**
     * Document ready: analyze
     **/
    $(document).ready(function () {
        scanDocument();
    });

    /**Undo/redo key captures**/
    $(document).keydown(function (e) {
        console.log("Key press: " + e.which);
        if( e.which === 90 && e.metaKey && e.shiftKey ){
            Redo();
        }
        else if( e.which === 90 && e.metaKey){
            Undo();
        }
    });

    /**On scroll, dynamically show/hide the options**/
    $('#recommendations').on('scroll', function() {
        if ($(this).scrollTop() > 5) {
            $("#pargraphOneSettings").css("display", "none");
            // $('#recommendations').css("height", "96%");
            SetOptionsVisible(false);
        }
        else {
            $("#pargraphOneSettings").css("display", "flex");
            // $('#recommendations').css("height", "93%");

        }
      });

    /** Undo/redo functions **/
    function Undo(){
      //TODO
    }

    function Redo(){
      //TODO
    }

    /** Toggle settings visible **/
    $('#settingsIcon').click(function () {
        SetOptionsVisible(!($('#clearHidden').css("display") ===  "block"));
    });

    function SetOptionsVisible(visible){
        if(visible){
            $('#clearHidden').css("display", "block");
        }
        else{
            $('#clearHidden').css("display", "none");
        }
        $('#recommendations').css("height", "90%");
    }

    /** Clear hidden items **/
    $('#clearHidden').click(function () {
        google.script.run
            .withSuccessHandler(function (docID) {
                if(docID === null) {
                    console.log("Failed to obtain document id");
                }
                else {
                    localStorage.removeItem(docID);
                    SetOptionsVisible(false);
                    scanDocument();
                }
            })
            .withFailureHandler({})
            .getDocumentID();
    });

    /** Analyze button clicked**/
    $('#analyzeBtn').click(function () {
        console.log("Analyzing");
        scanDocument();
    });

    /** + clicked to toggle section collapsed **/
    $('#recommendations').on('click', '.collapse', function(){
      toggle_section_visble(this.id)
    });
    $('.collapse').click(function(){
      console.log("Toggling 1");
      toggle_section_visble(this.id);
    });

    function toggle_section_visble(id){
      var item_to_toggle_id = id.replace("paragraph", "recommendations");
      var item_to_toggle = $("#"+item_to_toggle_id);
      if(item_to_toggle.css("display") ===  "inline-block"){
        item_to_toggle.css("display", "none");
      }
      else{
        item_to_toggle.css("display", "inline-block");
      }
    }

    /** Thumbs up clicked */
    $('#recommendations').on('click', '.thumbs_up', function() {
        var selected_index = 0;
        var is_multivalue = $('.radio_' + this.id).length > 1;
        console.log("Is multi: " + is_multivalue);
        if(is_multivalue){
          var selected_item = $('.radio_' + this.id + ':checked'); //TODO selected many
          if(selected_item !== null && selected_item.length === 1){
            selected_index = selected_item.attr("id");
            console.log("Selected item: " + selected_index);
          }
          else {
            console.log("No item selected");
            showError("Please select an option");
            return;
          }
        }

        thumbClicked(this.id, true, selected_index);
    });

    /** Thumbs down clicked **/
    $('#recommendations').on('click', '.thumbs_down', function() {
        thumbClicked(this.id, false, -1);
    });

    /** Generic thumb up/down clicked method **/
    function thumbClicked(recID, accepted, accepted_ans){
        $("#" + recID+ ".recommendationCard").remove();//Delete card
        if(accepted) {
          console.log(recID + " - ID " + accepted_ans);
            google.script.run
                .withSuccessHandler()
                .withFailureHandler()
                .DoSubstitution(recID, accepted_ans);
        }
        else{
            google.script.run
                .withSuccessHandler()
                .withFailureHandler()
                .UndoHighlighting(recID);
        }
        google.script.run
            .withSuccessHandler(function (docID) {
                if(docID === null) {
                    console.log("Failed to obtain document id");
                }
                else {
                    google.script.run         //ajax to API that the user hid that card(UID)
                        .withSuccessHandler()
                        .withFailureHandler()
                        .ThumbsClicked(recID, accepted);

                    var hiddenRecs = localStorage.getItem(docID);
                    if (hiddenRecs === null || hiddenRecs === "") {
                        let newEntry = {"hidden": [recID.toString()]};
                        localStorage.setItem(docID, JSON.stringify(newEntry))
                    }
                    else {
                        let hiddenEntries = JSON.parse(hiddenRecs);
                        //hiddenEntries should be an object structured: {"hidden":[hidden1, hidden2,...]}
                        hiddenEntries["hidden"].push(recID.toString());
                        localStorage.setItem(docID, JSON.stringify(hiddenEntries))
                    }
                }
            })
            .withFailureHandler({})
            .getDocumentID();
    }

    /** Show an error **/
    function showError(msg) {
      $('errors').css("display", "block");
      $('errors').html(msg);

    }
    /**
     * Request the server to scan the opened document.
     */
    function scanDocument() {
        $("#resultsDiv").hide();
        $('#systemErrorDiv').hide();
        $('#simpleToComplexErrorsDiv').hide();
        $('#noErrorsDiv').hide();
        $('#errorsFoundMsg').hide();
        $('#simpleToComplexErrorListDiv').empty();
        $('#passiveHardReccListDiv').empty();
        $('#passiveHardReccDiv').hide();
        $('#passiveSoftReccListDiv').empty();
        $('#passiveSoftReccDiv').hide();
        $('#refreshPng').show();

        google.script.run
            .withSuccessHandler(function (docID) {
                if(docID === null) {
                    console.log("Failed to obtain document id");
                }
                else {
                    var hiddenStore = localStorage.getItem(docID);
                    var hiddenVals = hiddenStore !== null ? JSON.parse(hiddenStore) : null;
                    google.script.run
                        .withSuccessHandler(function (result) { //result = [html, newCache]
                            //scanDocument returns structured html, no just put it in the correct div
                            $('#recommendations').html(result[0]);
                            $('#refreshPng').hide();
                            $('#paragraphOne').css('visibility', 'visible');
                            if(result[1].length > 0) { //Update with the calculated diff of hidden items
                                localStorage.setItem(docID, JSON.stringify({"hidden":result[1]}))
                            }
                            else //We should not be hiding anything, delete out local store
                            {
                                localStorage.removeItem(docID);
                            }
                        })
                        .withFailureHandler(
                            function (reason) {
                                console.log("Failed to scan document because: " + reason);
                                $('#refreshPng').hide();
                                $('#systemErrorDiv').show();
                            }
                        )
                        .scanDocument(hiddenVals === null ? null : hiddenVals["hidden"]);
                }
            })
            .withFailureHandler({})
            .getDocumentID();

    }
</script>


</html>